// components/server/ProductSchema.tsx - INTERFACE MISE Ã€ JOUR MULTI-CATÃ‰GORIES
import type { Product, Category, SubCategory } from '@/lib/types';
import { getProductImageUrl } from '@/lib/firebase-utils';

// âœ… INTERFACE MISE Ã€ JOUR POUR MULTI-CATÃ‰GORIES
interface ProductSchemaProps {
  product: Product;
  
  // âœ… NOUVELLES PROPS MULTI-CATÃ‰GORIES
  categories: Category[];           // ðŸ”„ Tableau de toutes les catÃ©gories
  subCategories: SubCategory[];     // ðŸ”„ Tableau de toutes les sous-catÃ©gories
  
  // âœ… PROPS DE RÃ‰TROCOMPATIBILITÃ‰ (optionnelles)
  primaryCategory?: Category | null;      // ðŸ”„ CatÃ©gorie principale pour rÃ©trocompatibilitÃ©
  primarySubCategory?: SubCategory | null; // ðŸ”„ Sous-catÃ©gorie principale pour rÃ©trocompatibilitÃ©
  
  // âœ… PROPS EXISTANTES
  similarProducts: Product[];
  
  // ðŸ†• PROPS HÃ‰RITÃ‰ES (pour compatibilitÃ© avec l'ancien code)
  category?: Category | null;       // ðŸ”„ DÃ©prÃ©ciÃ© mais supportÃ©
  subCategory?: SubCategory | null; // ðŸ”„ DÃ©prÃ©ciÃ© mais supportÃ©
}

/**
 * Composant server ProductSchema - DonnÃ©es structurÃ©es Schema.org avec support multi-catÃ©gories
 * 
 * FonctionnalitÃ©s :
 * âœ… Schema.org Product complet avec multi-catÃ©gories
 * âœ… Schema.org BreadcrumbList intelligent
 * âœ… Schema.org Offer avec prix et disponibilitÃ©
 * âœ… Schema.org AggregateRating
 * âœ… Schema.org ItemList pour produits similaires
 * âœ… Optimisation SEO e-commerce multi-catÃ©gories
 */
export default function ProductSchema({ 
  product,
  categories = [],
  subCategories = [],
  primaryCategory = null,
  primarySubCategory = null,
  category = null,    // ðŸ”„ RÃ©trocompatibilitÃ©
  subCategory = null, // ðŸ”„ RÃ©trocompatibilitÃ©
  similarProducts
}: ProductSchemaProps) {
  
  // âœ… DÃ‰TERMINATION INTELLIGENTE DE LA CATÃ‰GORIE Ã€ UTILISER
  const displayCategory = primaryCategory || category || categories[0] || null;
  const displaySubCategory = primarySubCategory || subCategory || subCategories[0] || null;
  
  // Construction de l'URL de l'image principale
  const productImage = getProductImageUrl(product);
  const imageUrl = productImage.startsWith('http') 
    ? productImage 
    : `https://beautydiscount.ma${productImage}`;
  
  // âœ… GÃ‰NÃ‰RATION INTELLIGENTE DES CATÃ‰GORIES POUR SCHEMA.ORG
  const generateCategoryString = () => {
    if (subCategories.length > 0) {
      return subCategories[0].name;
    }
    if (categories.length > 0) {
      return categories[0].name;
    }
    return displaySubCategory?.name || displayCategory?.name || "BeautÃ©";
  };
  
  // âœ… GÃ‰NÃ‰RATION DES PROPRIÃ‰TÃ‰S ADDITIONNELLES MULTI-CATÃ‰GORIES
  const generateAdditionalProperties = () => {
    const properties = [];
    
    // Contenance
    if (product.contenance) {
      properties.push({
        "@type": "PropertyValue",
        "name": "Contenance",
        "value": product.contenance
      });
    }
    
    // RÃ©fÃ©rence
    properties.push({
      "@type": "PropertyValue",
      "name": "RÃ©fÃ©rence",
      "value": product.sku
    });
    
    // CatÃ©gories multiples
    if (categories.length > 1) {
      properties.push({
        "@type": "PropertyValue",
        "name": "CatÃ©gories",
        "value": categories.map(c => c.name).join(", ")
      });
    }
    
    // Sous-catÃ©gories multiples
    if (subCategories.length > 1) {
      properties.push({
        "@type": "PropertyValue",
        "name": "Sous-catÃ©gories", 
        "value": subCategories.map(s => s.name).join(", ")
      });
    }
    
    // Indicateur multi-catÃ©gories
    if (categories.length > 1 || subCategories.length > 1) {
      properties.push({
        "@type": "PropertyValue",
        "name": "Classification",
        "value": "Produit multi-catÃ©gories"
      });
    }
    
    return properties;
  };
  
  // Schema.org Product principal avec support multi-catÃ©gories
  const productSchema = {
    "@context": "https://schema.org",
    "@type": "Product",
    "name": product.name,
    "description": product.shortDescription || product.description,
    "sku": product.sku,
    "image": [imageUrl, ...product.images.slice(1, 4)], // Jusqu'Ã  4 images
    "url": `https://beautydiscount.ma/products/${product.slug}`,
    
    // Marque
    ...(product.brandName && {
      "brand": {
        "@type": "Brand",
        "name": product.brandName
      }
    }),
    
    // âœ… CATÃ‰GORIE INTELLIGENTE MULTI-CATÃ‰GORIES
    "category": generateCategoryString(),
    
    // âœ… CATÃ‰GORIES ADDITIONNELLES (extension Schema.org)
    ...(categories.length > 1 && {
      "additionalType": categories.map(c => `https://beautydiscount.ma/categories/${c.slug}`)
    }),
    
    // âœ… PROPRIÃ‰TÃ‰S ADDITIONNELLES ENRICHIES
    "additionalProperty": generateAdditionalProperties(),
    
    // Offre commerciale
    "offers": {
      "@type": "Offer",
      "price": product.price.toString(),
      "priceCurrency": "MAD",
      "availability": getAvailabilitySchema(product.stock),
      "itemCondition": "https://schema.org/NewCondition",
      "seller": {
        "@type": "Organization",
        "name": "BeautyDiscount",
        "url": "https://beautydiscount.ma"
      },
      "validFrom": new Date().toISOString(),
      
      // Prix de rÃ©fÃ©rence si en promotion
      ...(product.originalPrice && product.originalPrice > product.price && {
        "priceValidUntil": new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString(), // 30 jours
        "highPrice": product.originalPrice.toString()
      })
    },
    
    // Ã‰valuation agrÃ©gÃ©e (donnÃ©es factices pour l'exemple)
    "aggregateRating": {
      "@type": "AggregateRating",
      "ratingValue": "4.5",
      "reviewCount": "23",
      "bestRating": "5",
      "worstRating": "1"
    },
    
    // Avis rÃ©cents (donnÃ©es factices)
    "review": [
      {
        "@type": "Review",
        "reviewRating": {
          "@type": "Rating",
          "ratingValue": "5",
          "bestRating": "5"
        },
        "author": {
          "@type": "Person",
          "name": "Sarah M."
        },
        "reviewBody": "Excellent produit ! TrÃ¨s satisfaite de mon achat.",
        "datePublished": "2025-09-15"
      },
      {
        "@type": "Review",
        "reviewRating": {
          "@type": "Rating",
          "ratingValue": "4", 
          "bestRating": "5"
        },
        "author": {
          "@type": "Person",
          "name": "Amina K."
        },
        "reviewBody": "Bon produit, conforme Ã  mes attentes.",
        "datePublished": "2025-09-10"
      }
    ]
  };
  
  // âœ… BREADCRUMB INTELLIGENT MULTI-CATÃ‰GORIES
  const generateBreadcrumbSchema = () => {
    const breadcrumbItems = [
      {
        "@type": "ListItem",
        "position": 1,
        "name": "Accueil",
        "item": "https://beautydiscount.ma"
      },
      {
        "@type": "ListItem",
        "position": 2,
        "name": "CatÃ©gories",
        "item": "https://beautydiscount.ma/categories"
      }
    ];
    
    let currentPosition = 3;
    
    // Ajouter la catÃ©gorie principale
    if (displayCategory) {
      breadcrumbItems.push({
        "@type": "ListItem",
        "position": currentPosition++,
        "name": displayCategory.name,
        "item": `https://beautydiscount.ma/categories/${displayCategory.slug}`
      });
    }
    
    // Ajouter la sous-catÃ©gorie principale
    if (displaySubCategory) {
      breadcrumbItems.push({
        "@type": "ListItem",
        "position": currentPosition++,
        "name": displaySubCategory.name,
        "item": `https://beautydiscount.ma/categories/${displayCategory?.slug}/${displaySubCategory.slug}`
      });
    }
    
    // Ajouter le produit
    breadcrumbItems.push({
      "@type": "ListItem",
      "position": currentPosition,
      "name": product.name,
      "item": `https://beautydiscount.ma/products/${product.slug}`
    });
    
    return {
      "@context": "https://schema.org",
      "@type": "BreadcrumbList",
      "itemListElement": breadcrumbItems
    };
  };
  
  // Schema.org Organization (BeautyDiscount)
  const organizationSchema = {
    "@context": "https://schema.org",
    "@type": "Organization",
    "name": "BeautyDiscount",
    "url": "https://beautydiscount.ma",
    "logo": "https://beautydiscount.ma/logo.png",
    "contactPoint": {
      "@type": "ContactPoint",
      "telephone": "+212-XXX-XXXXXX",
      "contactType": "Customer Service",
      "availableLanguage": ["French", "Arabic"]
    },
    "address": {
      "@type": "PostalAddress",
      "addressLocality": "Casablanca",
      "addressCountry": "MA"
    },
    "sameAs": [
      "https://www.facebook.com/beautydiscount",
      "https://www.instagram.com/beautydiscount"
    ]
  };
  
  // âœ… SCHEMA ITEMLIST POUR PRODUITS SIMILAIRES ENRICHI
  const generateSimilarProductsSchema = () => {
    if (similarProducts.length === 0) return null;
    
    return {
      "@context": "https://schema.org",
      "@type": "ItemList",
      "name": "Produits similaires",
      "description": `Produits similaires Ã  ${product.name}${categories.length > 1 ? ` dans ${categories.length} catÃ©gories` : ''}`,
      "numberOfItems": similarProducts.length,
      "itemListElement": similarProducts.map((item, index) => ({
        "@type": "ListItem",
        "position": index + 1,
        "item": {
          "@type": "Product",
          "name": item.name,
          "url": `https://beautydiscount.ma/products/${item.slug}`,
          "image": getProductImageUrl(item).startsWith('http') 
            ? getProductImageUrl(item)
            : `https://beautydiscount.ma${getProductImageUrl(item)}`,
          "offers": {
            "@type": "Offer",
            "price": item.price.toString(),
            "priceCurrency": "MAD",
            "availability": getAvailabilitySchema(item.stock)
          },
          ...(item.brandName && {
            "brand": {
              "@type": "Brand",
              "name": item.brandName
            }
          }),
          // âœ… CATÃ‰GORIE POUR PRODUITS SIMILAIRES
          "category": item.categoryIds.length > 0 ? "BeautÃ©" : generateCategoryString()
        }
      }))
    };
  };
  
  // âœ… SCHEMA WEBPAGE ENRICHI MULTI-CATÃ‰GORIES
  const webPageSchema = {
    "@context": "https://schema.org",
    "@type": "WebPage",
    "name": `${product.name} | BeautyDiscount`,
    "description": product.shortDescription || product.description,
    "url": `https://beautydiscount.ma/products/${product.slug}`,
    "mainEntity": {
      "@id": `https://beautydiscount.ma/products/${product.slug}#product`
    },
    "breadcrumb": {
      "@id": `https://beautydiscount.ma/products/${product.slug}#breadcrumb`
    },
    "isPartOf": {
      "@type": "WebSite",
      "name": "BeautyDiscount",
      "url": "https://beautydiscount.ma"
    },
    // âœ… MENTIONS DES CATÃ‰GORIES MULTIPLES
    ...(categories.length > 1 && {
      "mentions": categories.map(cat => ({
        "@type": "Thing",
        "name": cat.name,
        "url": `https://beautydiscount.ma/categories/${cat.slug}`
      }))
    })
  };

  const breadcrumbSchema = generateBreadcrumbSchema();
  const similarProductsSchema = generateSimilarProductsSchema();

  return (
    <>
      {/* Schema.org Product principal */}
      <script
        type="application/ld+json"
        dangerouslySetInnerHTML={{
          __html: JSON.stringify({
            ...productSchema,
            "@id": `https://beautydiscount.ma/products/${product.slug}#product`
          })
        }}
      />
      
      {/* Schema.org Breadcrumb */}
      <script
        type="application/ld+json"
        dangerouslySetInnerHTML={{
          __html: JSON.stringify({
            ...breadcrumbSchema,
            "@id": `https://beautydiscount.ma/products/${product.slug}#breadcrumb`
          })
        }}
      />
      
      {/* Schema.org Organization */}
      <script
        type="application/ld+json"
        dangerouslySetInnerHTML={{
          __html: JSON.stringify(organizationSchema)
        }}
      />
      
      {/* Schema.org WebPage */}
      <script
        type="application/ld+json"
        dangerouslySetInnerHTML={{
          __html: JSON.stringify(webPageSchema)
        }}
      />
      
      {/* Schema.org Similar Products */}
      {similarProductsSchema && (
        <script
          type="application/ld+json"
          dangerouslySetInnerHTML={{
            __html: JSON.stringify(similarProductsSchema)
          }}
        />
      )}
      
      {/* âœ… SCHEMA SPÃ‰CIAL MULTI-CATÃ‰GORIES */}
      {categories.length > 1 && (
        <script
          type="application/ld+json"
          dangerouslySetInnerHTML={{
            __html: JSON.stringify({
              "@context": "https://schema.org",
              "@type": "ItemList",
              "name": `CatÃ©gories de ${product.name}`,
              "description": `Ce produit appartient Ã  ${categories.length} catÃ©gories diffÃ©rentes`,
              "numberOfItems": categories.length,
              "itemListElement": categories.map((cat, index) => ({
                "@type": "ListItem",
                "position": index + 1,
                "item": {
                  "@type": "Thing",
                  "name": cat.name,
                  "url": `https://beautydiscount.ma/categories/${cat.slug}`
                }
              }))
            })
          }}
        />
      )}
    </>
  );
}

/**
 * Fonction helper pour convertir le stock en schema de disponibilitÃ©
 */
function getAvailabilitySchema(stock: string): string {
  switch (stock) {
    case 'En Stock':
      return "https://schema.org/InStock";
    case 'Sur Commande':
      return "https://schema.org/PreOrder";
    case 'Rupture':
      return "https://schema.org/OutOfStock";
    default:
      return "https://schema.org/InStock";
  }
}